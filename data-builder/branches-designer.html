<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Branch Designer</title>
  <style>
    :root {
      --bg: #0c101a;
      --panel: #111827;
      --panel-strong: #0f1724;
      --border: #1f2937;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #7dd3fc;
      --accent-2: #a5b4fc;
      --success: #34d399;
      --danger: #f87171;
      --warning: #fbbf24;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 24px;
      background: radial-gradient(circle at 20% 20%, rgba(125,211,252,0.04), transparent 35%), radial-gradient(circle at 80% 10%, rgba(165,180,252,0.05), transparent 35%), var(--bg);
      color: var(--text);
      font-family: "DM Sans", "Space Grotesk", "Inter", "SF Pro Text", system-ui, -apple-system, sans-serif;
      line-height: 1.5;
    }

    h1, h2 { margin: 0; font-weight: 700; letter-spacing: 0.02em; }
    p { margin: 0; }

    label {
      font-size: 0.85rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      display: block;
      margin-bottom: 6px;
    }

    input, select, textarea {
      width: 100%;
      background: #0b1220;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: "DM Mono", "JetBrains Mono", "Fira Code", monospace;
      transition: border-color 0.15s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(125,211,252,0.2);
    }

    button {
      cursor: pointer;
      border: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(125,211,252,0.14), rgba(165,180,252,0.10));
      color: var(--text);
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 700;
      transition: all 0.15s ease;
    }

    button:hover {
      border-color: var(--accent);
      box-shadow: 0 10px 20px rgba(0,0,0,0.25);
    }

    button.ghost {
      background: transparent;
      border-color: var(--border);
      color: var(--muted);
    }

    button.danger {
      background: rgba(248,113,113,0.12);
      border-color: rgba(248,113,113,0.6);
      color: var(--danger);
    }

    button.small { padding: 6px 10px; font-size: 0.85rem; }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .topbar .eyebrow {
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.16em;
      font-size: 0.75rem;
      margin-bottom: 4px;
    }

    .topbar h1 { font-size: 1.8rem; }

    .topbar .actions { display: flex; gap: 10px; flex-wrap: wrap; }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      align-items: start;
    }

    @media (max-width: 1100px) {
      .grid { grid-template-columns: 1fr; }
    }

    .panel {
      background: linear-gradient(180deg, var(--panel-strong), var(--panel));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
    }

    .panel__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 14px;
    }

    .input-grid { display: grid; gap: 12px; }
    .two-col { grid-template-columns: repeat(2, minmax(0, 1fr)); }

    .branch-card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      background: rgba(255,255,255,0.02);
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .branch-card:hover {
      border-color: var(--accent);
      background: rgba(125,211,252,0.06);
    }

    .branch-card.selected {
      border-color: var(--accent);
      background: rgba(125,211,252,0.1);
    }

    .branch-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .branch-name {
      font-weight: 700;
      color: var(--accent);
      font-size: 1.1rem;
    }

    .json-output {
      background: #0a0f18;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      overflow: auto;
      max-height: 70vh;
    }

    pre {
      margin: 0;
      color: var(--text);
      font-size: 0.9rem;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .hint {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .flex { display: flex; gap: 8px; align-items: center; }
    .stacked { display: grid; gap: 12px; }
  </style>
</head>
<body>
  <header class="topbar">
    <div>
      <div class="eyebrow">crime committer vi</div>
      <h1>Branch Designer</h1>
      <p class="hint">Design crime branches: metadata, order, colors, hotkeys.</p>
      <div style="margin-top: 8px; display: flex; gap: 12px; align-items: center; font-size: 0.85rem;">
        <span id="serverStatus" style="color: var(--muted);">● Checking...</span>
        <span id="saveIndicator" style="color: var(--warning); display: none;">● Unsaved changes</span>
        <span class="hint">Ctrl+S: Save | Ctrl+N: New</span>
      </div>
    </div>
    <div class="actions">
      <button class="small" onclick="saveBranches()">Save All</button>
      <button class="ghost small" onclick="addNewBranch()">+ New Branch</button>
      <button class="ghost small" onclick="window.location.href='index.html'">← Back</button>
    </div>
  </header>

  <div class="grid">
    <div class="stacked">
      <section class="panel">
        <div class="panel__header">
          <h2>Branch List</h2>
          <span class="hint">Click to edit</span>
        </div>
        <div id="branchList"></div>
      </section>

      <section class="panel" id="editorPanel" style="display: none;">
        <div class="panel__header">
          <h2>Edit Branch</h2>
          <button class="ghost small" onclick="deleteBranch()">Delete</button>
        </div>
        <div class="input-grid two-col">
          <div>
            <label for="branchId">Branch ID</label>
            <input type="text" id="branchId" placeholder="street">
          </div>
          <div>
            <label for="branchName">Name (UPPERCASE)</label>
            <input type="text" id="branchName" placeholder="STREET">
          </div>
          <div>
            <label for="branchDescription">Description</label>
            <textarea id="branchDescription" placeholder="low stakes crimes" rows="2"></textarea>
          </div>
          <div class="input-grid">
            <label for="branchOrder">Order (for sorting)</label>
            <input type="number" id="branchOrder" placeholder="10" min="0">
            <label for="branchHotkey">Hotkey (single char)</label>
            <input type="text" id="branchHotkey" placeholder="t" maxlength="1">
          </div>
          <div>
            <label for="branchColor">UI Color</label>
            <select id="branchColor">
              <option value="NEON_CYAN">NEON_CYAN</option>
              <option value="NEON_TEAL">NEON_TEAL</option>
              <option value="LAVA_RED">LAVA_RED</option>
              <option value="ELECTRIC_BLUE">ELECTRIC_BLUE</option>
              <option value="GOLD">GOLD</option>
              <option value="HOT_PINK">HOT_PINK</option>
              <option value="TERMINAL_GREEN">TERMINAL_GREEN</option>
              <option value="SUCCESS_GREEN">SUCCESS_GREEN</option>
            </select>
          </div>
          <div>
            <label for="branchGradient">Gradient (optional)</label>
            <input type="text" id="branchGradient" placeholder="street">
          </div>
        </div>
        <div style="margin-top: 12px;">
          <label>
            <input type="checkbox" id="revealedByDefault"> Revealed by default
          </label>
        </div>
      </section>
    </div>

    <div class="stacked">
      <section class="panel">
        <div class="panel__header">
          <h2>File Status</h2>
          <button class="ghost small" onclick="loadBranches()">Refresh</button>
        </div>
        <p id="fileStatus" class="hint">Loading...</p>
      </section>

      <section class="panel">
        <div class="panel__header">
          <h2>JSON Output</h2>
          <button class="ghost small" onclick="copyJSON()">Copy</button>
        </div>
        <div class="json-output">
          <pre id="jsonOutput">[]</pre>
        </div>
      </section>
    </div>
  </div>

  <script src="hub-storage.js"></script>
  <script>
    let branches = [];
    let selectedIndex = -1;
    let serverOnline = false;
    let lastSavedState = null;
    const HUB_FILE = 'branches.json';

    document.addEventListener('DOMContentLoaded', () => {
      loadBranches();
      checkServerStatus();
      wireKeyboardShortcuts();
      wireInputs();
      wireHubEvents();
    });

    async function checkServerStatus() {
      try {
        const res = await fetch('/api/health');
        serverOnline = res.ok;
      } catch (err) {
        serverOnline = false;
      }
      updateServerIndicator();
    }

    function updateServerIndicator() {
      const el = document.getElementById('serverStatus');
      if (serverOnline) {
        el.textContent = '● Online';
        el.style.color = '#34d399';
      } else {
        el.textContent = '● Offline';
        el.style.color = '#f87171';
      }
    }

    function wireHubEvents() {
      const hub = window.CcvibesHubStorage;
      if (!hub) return;
      window.addEventListener('storage', (e) => {
        if (e.key === hub.savedKey(HUB_FILE)) {
          loadBranches();
          setStatus('Saved externally. Reloaded.', 'success');
        }
      });
    }

    function wireKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
          e.preventDefault();
          saveBranches();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
          e.preventDefault();
          addNewBranch();
        }
      });
    }

    function wireInputs() {
      const inputs = ['branchId', 'branchName', 'branchDescription', 'branchOrder', 'branchHotkey', 'branchColor', 'branchGradient'];
      inputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateCurrentBranch);
      });

      const checkbox = document.getElementById('revealedByDefault');
      if (checkbox) checkbox.addEventListener('change', updateCurrentBranch);
    }

    function updateCurrentBranch() {
      if (selectedIndex < 0 || selectedIndex >= branches.length) return;

      const branch = branches[selectedIndex];
      branch.id = document.getElementById('branchId').value || '';
      branch.name = document.getElementById('branchName').value || '';
      branch.description = document.getElementById('branchDescription').value || '';
      branch.order = parseInt(document.getElementById('branchOrder').value, 10) || 0;
      branch.hotkey = document.getElementById('branchHotkey').value || '';
      branch.revealedByDefault = document.getElementById('revealedByDefault').checked;
      branch.ui = {
        color: document.getElementById('branchColor').value || 'NEON_CYAN',
        gradient: document.getElementById('branchGradient').value || ''
      };

      renderBranchList();
      renderJSON();
      updateSaveIndicator();
    }

    async function loadBranches() {
      try {
        const res = await fetch('/api/data/branches.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        branches = Array.isArray(data) ? data : [];
        lastSavedState = JSON.stringify(branches);
        renderBranchList();
        renderJSON();
        updateSaveIndicator();
        setStatus(`Loaded ${branches.length} branches.`, 'success');
      } catch (err) {
        setStatus(`Failed to load: ${err.message}`, 'error');
        branches = [];
      }
    }

    async function saveBranches() {
      if (!serverOnline) {
        setStatus('Server offline. Cannot save.', 'error');
        return;
      }

      // Validate
      const errors = validateBranches();
      if (errors.length) {
        setStatus(`Validation failed: ${errors.join(', ')}`, 'error');
        return;
      }

      try {
        const res = await fetch('/api/data/branches.json', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(branches)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        lastSavedState = JSON.stringify(branches);
        updateSaveIndicator();
        window.CcvibesHubStorage?.broadcastSaved(HUB_FILE);
        setStatus(`Saved ${branches.length} branches.`, 'success');
      } catch (err) {
        setStatus(`Failed to save: ${err.message}`, 'error');
      }
    }

    function validateBranches() {
      const errors = [];
      const ids = new Set();
      const hotkeys = new Set();

      branches.forEach((branch, idx) => {
        if (!branch.id || !branch.id.trim()) {
          errors.push(`Branch ${idx + 1} has no ID`);
        } else if (ids.has(branch.id)) {
          errors.push(`Duplicate ID: ${branch.id}`);
        } else {
          ids.add(branch.id);
        }

        if (branch.hotkey && hotkeys.has(branch.hotkey)) {
          errors.push(`Duplicate hotkey: ${branch.hotkey}`);
        } else if (branch.hotkey) {
          hotkeys.add(branch.hotkey);
        }
      });

      return errors;
    }

    function addNewBranch() {
      const newBranch = {
        id: `branch_${branches.length + 1}`,
        name: 'NEW BRANCH',
        description: '',
        order: (branches.length + 1) * 10,
        hotkey: '',
        revealedByDefault: false,
        ui: {
          color: 'NEON_CYAN',
          gradient: ''
        }
      };

      branches.push(newBranch);
      selectBranch(branches.length - 1);
      renderBranchList();
      renderJSON();
      updateSaveIndicator();
      setStatus('New branch added. Fill in details and save.', 'success');
    }

    function deleteBranch() {
      if (selectedIndex < 0 || selectedIndex >= branches.length) return;
      if (!confirm(`Delete branch "${branches[selectedIndex].id}"?`)) return;

      branches.splice(selectedIndex, 1);
      selectedIndex = -1;
      document.getElementById('editorPanel').style.display = 'none';
      renderBranchList();
      renderJSON();
      updateSaveIndicator();
      setStatus('Branch deleted. Save to persist.', 'warning');
    }

    function selectBranch(index) {
      selectedIndex = index;
      const branch = branches[index];

      document.getElementById('branchId').value = branch.id || '';
      document.getElementById('branchName').value = branch.name || '';
      document.getElementById('branchDescription').value = branch.description || '';
      document.getElementById('branchOrder').value = branch.order || 0;
      document.getElementById('branchHotkey').value = branch.hotkey || '';
      document.getElementById('branchColor').value = branch.ui?.color || 'NEON_CYAN';
      document.getElementById('branchGradient').value = branch.ui?.gradient || '';
      document.getElementById('revealedByDefault').checked = branch.revealedByDefault || false;

      document.getElementById('editorPanel').style.display = 'block';
      renderBranchList();
    }

    function renderBranchList() {
      const container = document.getElementById('branchList');
      if (!branches.length) {
        container.innerHTML = '<div class="hint">No branches loaded. Click "New Branch" to add one.</div>';
        return;
      }

      const sorted = branches.slice().sort((a, b) => (a.order || 0) - (b.order || 0));
      container.innerHTML = sorted.map((branch, idx) => {
        const actualIndex = branches.indexOf(branch);
        const isSelected = actualIndex === selectedIndex;
        return `
          <div class="branch-card ${isSelected ? 'selected' : ''}" onclick="selectBranch(${actualIndex})">
            <div class="branch-header">
              <span class="branch-name">${safe(branch.name || branch.id)}</span>
              <span class="hint">Order: ${branch.order || 0}</span>
            </div>
            <div class="hint">${safe(branch.description || 'No description')}</div>
            <div class="hint" style="margin-top: 4px;">
              ID: ${safe(branch.id)} | Hotkey: ${branch.hotkey || 'none'} | ${branch.revealedByDefault ? 'Revealed' : 'Hidden'}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderJSON() {
      const el = document.getElementById('jsonOutput');
      el.textContent = JSON.stringify(branches, null, 2);
    }

    function updateSaveIndicator() {
      const indicator = document.getElementById('saveIndicator');
      const current = JSON.stringify(branches);
      const hasChanges = current !== lastSavedState;

      if (hasChanges) {
        indicator.textContent = '● Unsaved changes';
        indicator.style.display = 'inline';
      } else {
        indicator.style.display = 'none';
      }

      syncHubStatus(hasChanges);
    }

    function countModifiedEntries(current, baseline) {
      const baselineMap = new Map();
      baseline.forEach((item, idx) => {
        const key = (item && item.id) ? item.id : `__idx_${idx}`;
        baselineMap.set(key, JSON.stringify(item));
      });

      let modified = 0;
      const seen = new Set();

      current.forEach((item, idx) => {
        const key = (item && item.id) ? item.id : `__idx_${idx}`;
        const currentJson = JSON.stringify(item);
        const baselineJson = baselineMap.get(key);
        if (!baselineJson || baselineJson !== currentJson) modified += 1;
        seen.add(key);
      });

      baselineMap.forEach((_, key) => {
        if (!seen.has(key)) modified += 1;
      });

      return modified;
    }

    function syncHubStatus(hasChanges) {
      const hub = window.CcvibesHubStorage;
      if (!hub) return;

      let modifiedCount = 0;
      if (hasChanges && lastSavedState) {
        try {
          const baseline = JSON.parse(lastSavedState);
          modifiedCount = countModifiedEntries(branches, Array.isArray(baseline) ? baseline : []);
        } catch {
          modifiedCount = 1;
        }
      }

      hub.setStatus(HUB_FILE, { dirty: !!hasChanges, modifiedCount, updatedAt: Date.now() });

      const canDraft = lastSavedState !== null;
      if (hasChanges && canDraft) hub.setDraft(HUB_FILE, branches);
      else hub.clearDraft(HUB_FILE);
    }

    function copyJSON() {
      const text = document.getElementById('jsonOutput').textContent;
      navigator.clipboard.writeText(text).then(() => {
        setStatus('JSON copied to clipboard', 'success');
      }).catch(() => {
        setStatus('Could not copy', 'error');
      });
    }

    function setStatus(message, kind) {
      const el = document.getElementById('fileStatus');
      el.textContent = message;

      if (kind === 'error') el.style.color = '#f87171';
      else if (kind === 'success') el.style.color = '#34d399';
      else if (kind === 'warning') el.style.color = '#fbbf24';
      else el.style.color = '';
    }

    function safe(value) {
      if (value === undefined || value === null) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }
  </script>
</body>
</html>
